<% if @post.nil? %>
  <div class="alert alert-warning">
    投稿が見つかりませんでした。
  </div>
  <%= link_to "投稿一覧に戻る", posts_path, class: "btn btn-primary" %>
<% else %>
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="mb-3">
        <%= link_to posts_path, class: "text-decoration-none" do %>
          <i class="bi bi-arrow-left"></i> 投稿一覧に戻る
        <% end %>
      </div>

      <div class="card shadow-sm mb-4">
        <% if (image_html = post_image_tag(@post, placeholder_height: "400px", html_options: { style: "max-height: 500px; object-fit: cover;" })) %>
          <%= image_html %>
        <% end %>
        <div class="card-body">
          <h1 class="card-title h2 mb-3"><%= @post.title %></h1>
          <div class="mb-3">
            <% if @post.categories.any? %>
              <% @post.categories.each do |category| %>
                <%= link_to posts_path(category: category.id), class: "badge bg-primary text-decoration-none me-1 mb-1" do %>
                  <i class="bi bi-tag"></i> <%= category.name %>
                <% end %>
              <% end %>
            <% else %>
              <span class="badge bg-secondary me-1 mb-1">
                <i class="bi bi-tag"></i> 未分類
              </span>
            <% end %>
          </div>

          <div class="d-flex align-items-center mb-4 text-muted">
            <i class="bi bi-person-circle me-2"></i>
            <span class="me-3"><%= @post.user.name %></span>
            <i class="bi bi-clock me-2"></i>
            <span><%= @post.created_at.strftime("%Y年%m月%d日 %H:%M") %></span>
          </div>
          <div class="card-text">
            <p class="lead"><%= simple_format(@post.description) %></p>
          </div>
          
          <% if @post.youtube_url.present? %>
            <div class="mt-4">
              <h3 class="h5 mb-3">関連動画</h3>
              <div class="ratio ratio-16x9">
                <% youtube_id = @post.youtube_url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/) %>
                <% if youtube_id %>
                  <iframe src="https://www.youtube.com/embed/<%= youtube_id[1] %>" allowfullscreen></iframe>
                <% else %>
                  <p class="text-muted">無効なYouTube URLです</p>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        <div class="card-footer bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <%= render 'posts/like_button', post: @post %>
            </div>
            <% if logged_in? && current_user == @post.user %>
              <div class="ms-auto">
                <%= link_to edit_post_path(@post), class: "btn btn-outline-secondary btn-sm" do %>
                  <i class="bi bi-pencil"></i> 編集
                <% end %>
                <%= button_to post_path(@post), method: :delete, 
                  onclick: "return confirm('本当に削除しますか？')",
                  class: "btn btn-outline-danger btn-sm" do %>
                <i class="bi bi-trash"></i> 削除
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- コメントセクション -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h3 class="h5 mb-0">
            <i class="bi bi-chat-dots"></i> コメント
            <span class="badge bg-secondary ms-2"><%= @post.comments.count %></span>
          </h3>
        </div>
        <div class="card-body">
          <% if logged_in? %>
            <%= form_with url: post_comments_path(@post), local: true, class: "mb-4" do |f| %>
              <% if flash[:alert] %>
                <div class="alert alert-danger">
                  <%= flash[:alert] %>
                </div>
              <% end %>
              <div class="mb-3">
                <%= f.text_area :content, name: "reaction[content]", class: "form-control", rows: 3, placeholder: "コメントを入力...", required: true %>
              </div>
              <%= f.submit "コメントを投稿", class: "btn btn-primary" %>
            <% end %>
          <% else %>
            <div class="alert alert-info mb-4">
              <%= link_to "ログイン", new_session_path, class: "alert-link" %>してコメントを投稿しましょう
            </div>
          <% end %>

          <div class="comments">
            <% if @post.comments.any? %>
              <% @post.comments.order(created_at: :asc).each do |comment| %>
                <div class="comment-item border-bottom pb-3 mb-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-person-circle me-2 text-primary"></i>
                        <strong class="me-2"><%= comment.user.name %></strong>
                        <small class="text-muted">
                          <i class="bi bi-clock"></i> <%= comment.created_at.strftime("%Y年%m月%d日 %H:%M") %>
                        </small>
                      </div>
                      <p class="mb-0"><%= simple_format(comment.content) %></p>
                    </div>
                    <% if logged_in? && comment.user == current_user %>
                      <div class="ms-3">
                        <%= button_to post_comment_path(@post, comment), 
                                      method: :delete, 
                                      data: { turbo_confirm: "本当に削除しますか？" }, 
                                      class: "btn btn-outline-danger btn-sm" do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <p class="text-muted text-center py-4 mb-0">まだコメントはありません</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>